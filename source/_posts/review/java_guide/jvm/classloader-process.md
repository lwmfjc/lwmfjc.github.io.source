---
title: 类加载过程
description: 类加载过程
categories:
  - 学习
tags:
  - 复习
  - 复习-javaGuide
  - 复习-javaGuide-jvm
date: 2022-12-16 10:06:50
updated: 2022-12-16 10:06:50
---

> 转载自https://github.com/Snailclimb/JavaGuide（添加小部分笔记）感谢作者!

# 类的声明周期

![image-20221216105424418](https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20221216105424418.png)

# 类加载过程

- Class文件，需要**加载到虚拟机中**之后才能运行和使用，那么虚拟机是**如何加载**这些Class文件呢
- 系统加载Class类文件需要三步：**加载**->**连接**->**初始化**。连接过程又分为三步：**验证**->**准备**->**解析**

## 加载

类加载的第一步，主要完成3件事情

1. **通过全类名**获取定义此类的**二进制字节流**
2. 将**字节流**所代表的**静态存储结构**，转换为**方法区**的**运行时数据结构**
3. 在内存中生成一个该类的**Class对象**，作为**方法区**这些数据的访问入口

> 虚拟机规范对上面3点不具体，比较灵活
>
> 1. 对于1 没有具体指明从哪里获取、怎样获取。可以从ZIP包读取 （JAR/EAR/WAR格式的基础）、其他文件生成（JSP）等

- 非数组类的加载阶段（加载阶段**获取类的二进制字节流**的动作）是可控性最强的阶段，这一步我们可以去完成还可以**自定义类加载器**去**控制字节流**的获取方式（重写一个类加载器的**loadClass()**方法
- 数组类型**不通过**类加载器创建，它由**Java虚拟机**直接创建

**加载阶段**和**连接阶段**的部分内容是**交叉执行**的，即加载阶段尚未结束，连接阶段就可能已经开始了

## 验证

![验证阶段示意图](https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/%25E9%25AA%258C%25E8%25AF%2581%25E9%2598%25B6%25E6%25AE%25B5.png)

## 准备

- 准备阶段是正式**为类变量分配内存**并**设置类变量初始值**的阶段，这些内存都将在**方法区**中分配，注意：

  1. 这时候进行内存分配的**仅**包括**类变量**（**ClassVariables**，即**静态变量**：被```static```关键字修饰的变量，**只与类相关**，因此被称为**类变量**），而**不包括**实例变量。

     > 实例变量会在**对象实例化**时，随着对象一块分配到**Java堆**中

  2. 从概念上讲，类变量所使用的内存都应当在 **方法区** 中进行分配。不过有一点需要注意的是：JDK 7 之前，HotSpot 使用永久代来实现方法区的时候，实现是完全符合这种逻辑概念的。 而在 **JDK 7 及之后**，HotSpot 已经把**原本放在永久代**的**字符串常量池**、**静态变量**等移动到**堆**中，这个时候**类变量**则会随着 **Class 对象（上面有提到，内存区生成Class对象）**一起存放在 Java 堆中

  3. 这里所设置的初始值**"通常情况"**下是**数据类型默认的零值（如 0、0L、null、false 等**），比如我们定义了**`public static int value=111`** ，那么 value 变量在准备阶段的**初始值就是 0 而不是 111**（初始化阶段才会赋值）。**特殊情况**：比如给 **value 变量加上了 final** 关键字`public static final int value=111` ，那么准备阶段 value 的值就被赋值为 111

- 基本数据类型的零值
  ![image-20221216114118285](https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20221216114118285.png)

## 解析

- 解析阶段是虚拟机将**常量池内的符号引用**替换为**直接引用**的过程

- 解析动作主要针对**类**或**接口**、**字段**、**类方法**、**接口方法**、**方法类型**、**方法句柄**和**调用限定符**7类**符号引用**进行

- **符号引用**就是**一组符号**来**描述目标**，可以是任何**字面量**。**直接引用**就是**直接指向目标的指针**、**相对偏移量**或一个**间接定位到目标**的句柄

  > - 程序实际运行时，只有**符号引用**时不够的。
  > - 在程序执行方法时，系统需要明确知道这个方法所在的位置

## 初始化

# 卸载