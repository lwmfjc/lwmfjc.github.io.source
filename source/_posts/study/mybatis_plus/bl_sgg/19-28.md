---
title: 19-28
description: 'mybatis-plus 尚硅谷'
categories:
  - 学习
tags:
  - mybatis-plus 尚硅谷
date: 2022-06-03 11:54:42
updated: 2022-06-03 11:54:42
---

##  通用Service应用

- 这里会出现 publicKey is now allowed ，在数据库连接语句后面加上这句话即可
   allowPublicKeyRetrieval=true

  ```yml
  spring:
    #配置数据源
    datasource:
      #配置数据源类型
      type: com.zaxxer.hikari.HikariDataSource
      #配置数据源各个信息
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/mybatis_plus?characterEncoding=utf-8&&useSSL=false&&allowPublicKeyRetrieval=true
      username: root
      password: 123456
  ```

- 查询

  ```java
      @Test
      public void testList(){
          //List<User> list = userService.list();
          long count = userService.count();
          System.out.println("总条数："+count);
      }
  ```

  SQL执行语句

  ```
  ==>  Preparing: SELECT COUNT( * ) FROM user
  ==> Parameters: 
  <==    Columns: COUNT( * )
  <==        Row: 5
  <==      Total: 1
  ```

- 批量添加

  ```java
      @Test
      public void batchInsert(){
          List<User> users=new ArrayList<>();
          for(int i=0;i<10;i++){
              User user=new User();
              user.setName("name"+i);
              user.setEmail("email"+i);
              users.add(user);
          }
  
          boolean b = userService.saveBatch(users);
          System.out.println("result:"+b);
      }
  ```

  sql日志输出

  ```java
  ==>  Preparing: INSERT INTO user ( id, name, email ) VALUES ( ?, ?, ? )
  ==> Parameters: 1532579686881243138(Long), name0(String), email0(String)
  ==> Parameters: 1532579687124512770(Long), name1(String), email1(String)
  ==> Parameters: 1532579687128707074(Long), name2(String), email2(String)
  ==> Parameters: 1532579687128707075(Long), name3(String), email3(String)
  ==> Parameters: 1532579687132901377(Long), name4(String), email4(String)
  ==> Parameters: 1532579687137095681(Long), name5(String), email5(String)
  ==> Parameters: 1532579687137095682(Long), name6(String), email6(String)
  ==> Parameters: 1532579687141289985(Long), name7(String), email7(String)
  ==> Parameters: 1532579687145484289(Long), name8(String), email8(String)
  ==> Parameters: 1532579687145484290(Long), name9(String), email9(String)
  result:true
  
  ```

  注意，这里是一个个的insert into ，而不是一条(单个的sql语句进行循环添加)

## MyBatis-Plus常用注解1

- 现在将mysql数据库表user名改为t_user 会提示下面的报错

  ```
  Cause: java.sql.BatchUpdateException: Table 'mybatis_plus.user' doesn't exist
  ```

  说明mybatis plus查询的时候会去找实体类名一样的表

- 使用@TableName("t_user") 设置实体类对应的表名

  ```java
  
  @Data
  @TableName("t_user")
  public class User {
      private Long id;
      private String name;
      private Integer age;
      private String email;
  }
  ```

  - 修改后执行成功

- 统一添加

  ```yml
  mybatis-plus:
    configuration:
    global-config:
      db-config:
        table-prefix: t_
  ```

- 指定主键名
  假设现在把数据库列名和bean的属性名id改为uid,此时新增一条记录

  ```
  Field 'uid' doesn't have a default value
  ; Field 'uid' doesn't have a default value; nested exception is java.sql.SQLException: Field 'uid' doesn't have a default value
  ```

  - 说明此时没有为uid赋值

- 使用@TableId告诉mybatis-plus那个字段为主键，让mybatis-plus为他赋默认值

  ```java
  @Data
  public class User {
      @TableId
      private Long uid;
      private String name;
      private Integer age;
      private String email;
  }
  ```

  sql打印

  ```
  ==>  Preparing: INSERT INTO t_user ( uid, name, age ) VALUES ( ?, ?, ? )
  ==> Parameters: 1532582462671618050(Long), 张三(String), 18(Integer)
  <==    Updates: 1
  ```

  

## @TableId的value属性

- 用于指定绑定的主键的字段
  假设此时将bean的主键属性名为id，数据库主键名是uid

- 此时运行，会提示

  ```java
  ### SQL: INSERT INTO t_user  ( id, name, age )  VALUES  ( ?, ?, ? )
  ### Cause: java.sql.SQLSyntaxErrorException: Unknown column 'id' in 'field list'
  ```

  他会拿bean的属性来生成sql语句

- 加上@TableId(value="uid")后运行正常

## @TableId的value属性

- ```java
  
  /**
   * 生成ID类型枚举类
   *
   * @author hubin
   * @since 2015-11-10
   */
  @Getter
  public enum IdType {
      /**
       * 数据库ID自增
       * <p>该类型请确保数据库设置了 ID自增 否则无效</p>
       */
      AUTO(0),
      /**
       * 该类型为未设置主键类型(注解里等于跟随全局,全局里约等于 INPUT)
       */
      NONE(1),
      /**
       * 用户输入ID
       * <p>该类型可以通过自己注册自动填充插件进行填充</p>
       */
      INPUT(2),
  
      /* 以下3种类型、只有当插入对象ID 为空，才自动填充。 */
      /**
       * 分配ID (主键类型为number或string）,
       * 默认实现类 {@link com.baomidou.mybatisplus.core.incrementer.DefaultIdentifierGenerator}(雪花算法)
       *
       * @since 3.3.0
       */
      ASSIGN_ID(3),
      /**
       * 分配UUID (主键类型为 string)
       * 默认实现类 {@link com.baomidou.mybatisplus.core.incrementer.DefaultIdentifierGenerator}(UUID.replace("-",""))
       */
      ASSIGN_UUID(4);
  
      private final int key;
  
      IdType(int key) {
          this.key = key;
      }
  }
  ```

- ```java
  //使用自增
  @TableId(value="uid",type = IdType.AUTO )
      private Long id;
     
  ```

- 然后将数据库主键设置为自动递增

- 新增后id为6
  

## 通过全局属性设置主键生成策略

- 全局配置设置

  ```yml
  mybatis-plus: 
    global-config:
      db-config: 
        id-type: auto
  ```

## 雪花算法

- 数据库扩展方式：主从复制、业务分库、数据库分表
- 数据库拆分：水平拆分、垂直拆分
- 水平分表相对垂直分表，会引入更多的复杂性，比如要求唯一的数据id该怎么处理
  - 可以给每个分表都给定一个范围大小，但是这样分段大小不好取
  - 可以取模，但是如果增加了机器，原来的值主键（怎么处理是个问题
  - 雪花算法，由Twitter公布的分布式主键生成算法 能够保证不同表的主键的不重复性，以及相同表的主键的有序性
  - 核心思想
    ![image-20220603182604230](https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20220603182604230.png)
  - 

## MyBatis-Plus常用注解2

## 条件构造器

## LambdaQueryWrapper

## MyBatis分页

## 悲观锁和乐观锁

## 模拟冲突

## 乐观锁插件

## 优化修改流程

## 通用枚举







